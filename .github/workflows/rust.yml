name: Deploy develop threisd-telegram-chatbot
run-name: ${{ github.actor }} is deploying develop branchðŸš€
on:
  push:
    branches:
      - "main"
jobs:
  prepare-env:
    name: Prepare ENV
    runs-on: [self-hosted, runner_dev]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Prepare ENV
        run: |
          echo "NGROK_AUTHTOKEN=${{ secrets.NGROK_AUTHTOKEN }}" >> .env
          echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" >> .env
          echo "SOCKET_ADDR=${{ vars.SOCKET_ADDR }}" >> .env
          echo "WEBHOOK_DOMAIN=${{ vars.WEBHOOK_DOMAIN }}" >> .env
  compile:
    name: Compile
    runs-on: [self-hosted, runner_dev]
    needs: [prepare-env]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Compile
        run: cargo build -r --jobs 1
  func:
    name: Run the work
    runs-on: [self-hosted, runner_dev]
    needs: [prepare-env, compile]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Run executable
        run: pm2 restart pm2-job.json
